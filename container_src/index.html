<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ghostty-web</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
      }

      .terminal-window {
        width: 100%;
        max-width: 1000px;
        background: #1e1e1e;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }

      .title-bar {
        background: #2d2d2d;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #1a1a1a;
      }

      .traffic-lights {
        display: flex;
        gap: 8px;
      }

      .light {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .light.red {
        background: #ff5f56;
      }
      .light.yellow {
        background: #ffbd2e;
      }
      .light.green {
        background: #27c93f;
      }

      .title {
        color: #e5e5e5;
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.3px;
      }

      .connection-status {
        margin-left: auto;
        font-size: 11px;
        color: #888;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #888;
      }

      .status-dot.connected {
        background: #27c93f;
      }
      .status-dot.disconnected {
        background: #ff5f56;
      }
      .status-dot.connecting {
        background: #ffbd2e;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .terminal-content {
        height: 600px;
        padding: 16px;
        background: #1e1e1e;
        position: relative;
        overflow: hidden;
      }

      /* Ensure terminal canvas can handle scrolling */
      .terminal-content canvas {
        display: block;
      }

      @media (max-width: 768px) {
        .terminal-content {
          height: 500px;
        }
      }
    </style>
  </head>
  <body>
    <div class="terminal-window">
      <div class="title-bar">
        <div class="traffic-lights">
          <div class="light red"></div>
          <div class="light yellow"></div>
          <div class="light green"></div>
        </div>
        <span class="title">ghostty-web</span>
        <div class="connection-status">
          <div class="status-dot connecting" id="status-dot"></div>
          <span id="status-text">Connecting...</span>
        </div>
      </div>
      <div class="terminal-content" id="terminal"></div>
    </div>

    <script type="module">
      import { init, Terminal, FitAddon } from "/dist/ghostty-web.js";

      await init();
      const term = new Terminal({
        cols: 80,
        rows: 24,
        fontFamily: "JetBrains Mono, Menlo, Monaco, monospace",
        fontSize: 14,
        theme: {
          background: "#1e1e1e",
          foreground: "#d4d4d4",
        },
      });

      const fitAddon = new FitAddon();
      term.loadAddon(fitAddon);

      const container = document.getElementById("terminal");
      await term.open(container);
      fitAddon.fit();
      fitAddon.observeResize(); // Auto-fit when container resizes

      // Status elements
      const statusDot = document.getElementById("status-dot");
      const statusText = document.getElementById("status-text");

      function setStatus(status, text) {
        statusDot.className = "status-dot " + status;
        statusText.textContent = text;
      }

      // Connect to WebSocket PTY server (use same origin as HTTP server)
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl =
        protocol +
        "//" +
        window.location.host +
        "/ws?cols=" +
        term.cols +
        "&rows=" +
        term.rows;
      let ws;

      function connect() {
        setStatus("connecting", "Connecting...");
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setStatus("connected", "Connected");
        };

        ws.onmessage = (event) => {
          term.write(event.data);
        };

        ws.onclose = () => {
          setStatus("disconnected", "Disconnected");
          term.write(
            "\\r\\n\\x1b[31mConnection closed. Reconnecting in 2s...\\x1b[0m\\r\\n"
          );
          setTimeout(connect, 2000);
        };

        ws.onerror = () => {
          setStatus("disconnected", "Error");
        };
      }

      connect();

      // Send terminal input to server
      term.onData((data) => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(data);
        }
      });

      // Handle resize - notify PTY when terminal dimensions change
      term.onResize(({ cols, rows }) => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "resize", cols, rows }));
        }
      });

      // Debounce function for resize events
      let resizeTimeout;
      function debouncedFit() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          fitAddon.fit();
        }, 50);
      }

      // Handle window resize
      window.addEventListener("resize", debouncedFit);
      
      // Use ResizeObserver for more reliable resize detection
      const resizeObserver = new ResizeObserver(debouncedFit);
      resizeObserver.observe(container);

      // Handle mobile keyboard showing/hiding using visualViewport API
      if (window.visualViewport) {
        const terminalContent = document.querySelector(".terminal-content");
        const terminalWindow = document.querySelector(".terminal-window");
        const originalHeight = terminalContent.style.height;
        const body = document.body;

        let viewportResizeTimeout;
        window.visualViewport.addEventListener("resize", () => {
          const keyboardHeight =
            window.innerHeight - window.visualViewport.height;
          if (keyboardHeight > 100) {
            body.style.padding = "0";
            body.style.alignItems = "flex-start";
            terminalWindow.style.borderRadius = "0";
            terminalWindow.style.maxWidth = "100%";
            terminalContent.style.height =
              window.visualViewport.height - 60 + "px";
            window.scrollTo(0, 0);
          } else {
            body.style.padding = "40px 20px";
            body.style.alignItems = "center";
            terminalWindow.style.borderRadius = "12px";
            terminalWindow.style.maxWidth = "1000px";
            terminalContent.style.height = originalHeight || "600px";
          }
          
          // Debounced fit for viewport changes
          clearTimeout(viewportResizeTimeout);
          viewportResizeTimeout = setTimeout(() => {
            fitAddon.fit();
          }, 100);
        });
      }
    </script>
  </body>
</html>
